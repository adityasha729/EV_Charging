<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charging</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c59 25%, #5fb3d4 50%, #2d5016 75%, #1a3409 100%);
            background-size: 400% 400%;
            animation: gradientShift 10s ease-in-out infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(50, 205, 50, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 70% 30%, rgba(34, 139, 34, 0.3) 0%, transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(144, 238, 144, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .energy-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .energy-bolt {
            position: absolute;
            font-size: 20px;
            color: rgba(255, 255, 0, 0.8);
            animation: energyFlow 4s infinite ease-in-out;
        }
        
        .energy-bolt:nth-child(1) { left: 15%; animation-delay: 0s; }
        .energy-bolt:nth-child(2) { left: 25%; animation-delay: 1s; }
        .energy-bolt:nth-child(3) { left: 35%; animation-delay: 2s; }
        .energy-bolt:nth-child(4) { left: 45%; animation-delay: 0.5s; }
        .energy-bolt:nth-child(5) { left: 55%; animation-delay: 1.5s; }
        .energy-bolt:nth-child(6) { left: 65%; animation-delay: 2.5s; }
        .energy-bolt:nth-child(7) { left: 75%; animation-delay: 3s; }
        .energy-bolt:nth-child(8) { left: 85%; animation-delay: 3.5s; }
        
        @keyframes energyFlow {
            0% { 
                transform: translateY(100vh) rotate(0deg) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translateY(90vh) rotate(180deg) scale(1);
            }
            90% {
                opacity: 1;
                transform: translateY(10vh) rotate(360deg) scale(1);
            }
            100% { 
                transform: translateY(0vh) rotate(540deg) scale(0);
                opacity: 0;
            }
        }
        
        .container {
            text-align: center;
            z-index: 10;
            position: relative;
            width: 90vw;
            max-width: 1000px;
            height: 90vh;
            max-height: 900px;
            padding: 2vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 28px;
            box-shadow: 
                0 40px 80px rgba(0, 0, 0, 0.3),
                0 20px 40px rgba(50, 205, 50, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(144, 238, 144, 0.4);
            animation: containerGlow 3s ease-in-out infinite;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }
        
        @keyframes containerGlow {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 40px 80px rgba(0, 0, 0, 0.3),
                    0 20px 40px rgba(50, 205, 50, 0.2),
                    inset 0 2px 0 rgba(255, 255, 255, 0.6);
            }
            50% { 
                transform: scale(1.01);
                box-shadow: 
                    0 44px 88px rgba(0, 0, 0, 0.35),
                    0 22px 44px rgba(50, 205, 50, 0.3),
                    inset 0 2px 0 rgba(255, 255, 255, 0.7);
            }
        }
        
        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            color: #2d5016;
            margin-bottom: 1.5vh;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
            line-height: 1.1;
            animation: titlePulse 2s ease-in-out infinite alternate;
        }
        
        @keyframes titlePulse {
            from { 
                color: #2d5016;
                text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
            }
            to { 
                color: #228B22;
                text-shadow: 2px 2px 12px rgba(34, 139, 34, 0.4);
            }
        }
        
        .charging-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 2vh;
            position: relative;
            animation: rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .charging-icon::before {
            content: 'âš¡';
            font-size: 60px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            animation: energyPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes energyPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                filter: brightness(1);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                filter: brightness(1.5);
            }
        }
        
        .countdown {
            font-size: 2.5rem;
            margin: 2vh 0;
            font-weight: 600;
            color: #2d5016;
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            padding: 1.5vh 2vw;
            border-radius: 16px;
            border: 2px solid #90EE90;
            box-shadow: 0 8px 24px rgba(144, 238, 144, 0.2);
            animation: countdownGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes countdownGlow {
            from { 
                box-shadow: 0 8px 24px rgba(144, 238, 144, 0.2);
                border-color: #90EE90;
            }
            to { 
                box-shadow: 0 12px 32px rgba(144, 238, 144, 0.4);
                border-color: #32CD32;
            }
        }
        
        .battery-container {
            margin: 2vh 0;
            padding: 2vh;
            background: linear-gradient(135deg, #f8fdf8, #eaf8ea);
            border-radius: 20px;
            border: 2px solid rgba(50, 205, 50, 0.3);
            box-shadow: inset 0 4px 8px rgba(144, 238, 144, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .battery-label {
            font-size: 1.3rem;
            color: #2d5016;
            font-weight: 600;
            margin-bottom: 1.5vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .battery-percentage {
            color: #228B22;
            font-size: 1.1rem;
        }
        
        .battery {
            width: 100%;
            max-width: 500px;
            height: 40px;
            border: 3px solid #2d5016;
            border-radius: 12px;
            position: relative;
            background: linear-gradient(135deg, #ffffff, #f8f8f8);
            margin: 0 auto;
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                0 4px 12px rgba(45, 80, 22, 0.2);
            overflow: hidden;
        }
        
        .battery::after {
            content: '';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 24px;
            background: linear-gradient(145deg, #2d5016, #1a3409);
            border-radius: 0 6px 6px 0;
        }
        
        .battery .charge-level {
            height: 100%;
            border-radius: 8px;
            width: 0%;
            background: linear-gradient(90deg, #ff4757 0%, #ffa502 50%, #2ed573 100%);
            background-size: 300% 100%;
            background-position: 100% 0;
            transition: width 1s ease-out, background-position 1s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .charge-level::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shine 2s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .charging-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5vw;
            margin: 2vh 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border: 2px solid rgba(144, 238, 144, 0.5);
            border-radius: 16px;
            padding: 1.5vh;
            text-align: center;
            box-shadow: 0 6px 18px rgba(144, 238, 144, 0.15);
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: #4a7c59;
            font-weight: 500;
            margin-bottom: 0.5vh;
        }
        
        .stat-value {
            font-size: 1.4rem;
            color: #2d5016;
            font-weight: 700;
        }
        
        .eco-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 16px;
            padding: 1.5vh 2vw;
            margin: 1vh 0;
            color: #155724;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .eco-icon {
            font-size: 1.5rem;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @media (max-height: 700px) {
            .container { 
                padding: 1vh;
                height: 95vh;
            }
            .charging-icon { width: 50px; height: 50px; }
            .charging-icon::before { font-size: 40px; }
            .battery { height: 30px; }
            .stat-card { padding: 1vh; }
            h1 { font-size: 2.5rem; }
            .countdown { font-size: 2rem; }
        }
        
        @media (min-height: 1080px) {
            .container {
                height: 85vh;
                max-height: 950px;
            }
        }
    </style>
    <script type="text/javascript" src="/static/js/TobiiWeb_Client.js"></script>
</head>
<!-- <body>
    <div class="background-overlay"></div>
    <div class="energy-particles">
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
    </div>
    
    <div class="container">
        <div class="charging-icon"></div>
        <h1>Charging Your Vehicle</h1>
        
        <div class="countdown" id="countdown">0 seconds remaining</div>
        
        <div class="battery-container">
            <div class="battery-label">
                <span>ðŸ”‹ Battery Progress</span>
                <span class="battery-percentage" id="batteryPercentage">0%</span>
            </div>
            <div class="battery">
                <div class="charge-level" id="chargeLevel"></div>
            </div>
        </div>
        
        <div class="charging-stats">
            <div class="stat-card">
                <div class="stat-title">Charging Speed</div>
                <div class="stat-value">Fast</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Power Source</div>
                <div class="stat-value">Green Energy</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Efficiency</div>
                <div class="stat-value">95%</div>
            </div>
        </div>
        
        <div class="eco-message">
            <div class="eco-icon">ðŸŒ±</div>
            <div>Powering your journey with clean, renewable energy</div>
        </div>
    </div>

    <script>
        var timeLeft = {{ charging_time }};
        var countdownElement = document.getElementById('countdown');
        var chargeLevel = document.getElementById('chargeLevel');
        var batteryPercentage = document.getElementById('batteryPercentage');
        var totalTime = timeLeft;

        let socket;

        // Check if the WebSocket connection exists in sessionStorage
        if (sessionStorage.getItem('socket') === 'connected') {
            socket = new WebSocket('ws://localhost:8080');
            socket.onopen = () => console.log('WebSocket connection reused.');

            // Continue Tobii EyeX tracking if WebSocket exists
            TobiiWeb_Client.start({
                enable_state_machine_logs: true,
                use_filter: "mean",
                services: [
                    { name: "GazeTracking_Service", page_url: window.location.href }
                ],
                onMessage: {
                    "GazeTracking_Service": GazeCoordinatesReceiver({
                        filter: "mean",
                        filter_size: 5,
                        onGazeCoordinates: function (x, y) {
                            const timeStamp = new Date().getTime();
                            const dateTimeStamp = new Date().toISOString();
                            const data = { x_axis: x, y_axis: y, timestamp: timeStamp, datetimestamp: dateTimeStamp };

                            // Send gaze data to the server
                            if (socket && socket.readyState === WebSocket.OPEN) {
                                socket.send(JSON.stringify(data));
                            }
                        }
                    })
                }
            });
        } else {
            console.log('No active WebSocket connection.');
        }

        // Enhanced color interpolation function for smooth gradient transitions
        function interpolateColor(percentage) {
            if (percentage <= 50) {
                // Red to Orange (0-50%)
                var red = 255;
                var green = Math.min(255, 255 * (percentage / 50));
                return `rgb(${red}, ${green}, 0)`;
            } else {
                // Orange to Green (50-100%)
                var red = Math.max(0, 255 * (2 - percentage / 50));
                var green = 255;
                return `rgb(${red}, ${green}, 0)`;
            }
        }

        function updateCountdown() {
            countdownElement.textContent = timeLeft + " seconds remaining";
            
            // Calculate the percentage of charging completed
            var percentage = ((totalTime - timeLeft) / totalTime) * 100;
            chargeLevel.style.width = percentage + "%";
            batteryPercentage.textContent = Math.round(percentage) + "%";

            // Update background position for gradient effect
            var backgroundPos = 100 - percentage;
            chargeLevel.style.backgroundPosition = backgroundPos + "% 0";

            if (timeLeft > 0) {
                timeLeft--;
                setTimeout(updateCountdown, 1000);
            } else {
                // Redirect to the next page after charging completes
                window.location.href = "/disabled_charging";
            }
        }

        // Start the countdown and charging animation
        updateCountdown();

        // Add subtle interaction effects for eye tracking studies
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('mousemove', function(e) {
                const container = document.querySelector('.container');
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                
                const rotateX = (y / rect.height) * 1.5;
                const rotateY = (x / rect.width) * -1.5;
                
                container.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
            
            document.addEventListener('mouseleave', function() {
                const container = document.querySelector('.container');
                container.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
            });
        });
    </script>
</body> -->


<body>
    <div class="background-overlay"></div>
    <div class="energy-particles">
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
        <div class="energy-bolt">âš¡</div>
    </div>
    
    <div class="container">
        <div class="charging-icon"></div>
        <h1>Charging Your Vehicle</h1>
        
        <div class="countdown" id="countdown">0 seconds remaining</div>
        
        <div class="battery-container">
            <div class="battery-label">
                <span>ðŸ”‹ Battery Progress</span>
                <span class="battery-percentage" id="batteryPercentage">{{ current_charge }}%</span>
            </div>
            <div class="battery">
                <div class="charge-level" id="chargeLevel"></div>
            </div>
        </div>
        
        <div class="charging-stats">
            <div class="stat-card">
                <div class="stat-title">Charging Speed</div>
                <div class="stat-value">Fast</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Power Source</div>
                <div class="stat-value">Green Energy</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Efficiency</div>
                <div class="stat-value">95%</div>
            </div>
        </div>
        
        <div class="eco-message">
            <div class="eco-icon">ðŸŒ±</div>
            <div>Powering your journey with clean, renewable energy</div>
        </div>
    </div>

    <script>
        // var timeLeft = {{ charging_time }};
        // var currentCharge = {{ current_charge }};
        // var chargeAmount = {{ charge_amount }};
        // var timeLeft = {{ charging_time }};
        // var currentCharge = 55;
        // var chargeAmount = 20;
        var timeLeft = Number("{{ charging_time | default(0) }}") || 0;
        var currentCharge = Number("{{ current_charge | default(0) }}") || 0;
        var chargeAmount = Number("{{ charge_amount | default(0) }}") || 0;
        var finalCharge = Math.min(currentCharge + chargeAmount, 100); // Cap at 100%
        var countdownElement = document.getElementById('countdown');
        var chargeLevel = document.getElementById('chargeLevel');
        var batteryPercentage = document.getElementById('batteryPercentage');
        var totalTime = timeLeft;

        // Set initial charge level
        chargeLevel.style.width = currentCharge + "%";

        let socket;

        // Check if the WebSocket connection exists in sessionStorage
        if (sessionStorage.getItem('socket') === 'connected') {
            socket = new WebSocket('ws://localhost:8080');
            socket.onopen = () => console.log('WebSocket connection reused.');

            // Continue Tobii EyeX tracking if WebSocket exists
            TobiiWeb_Client.start({
                enable_state_machine_logs: true,
                use_filter: "mean",
                services: [
                    { name: "GazeTracking_Service", page_url: window.location.href }
                ],
                onMessage: {
                    "GazeTracking_Service": GazeCoordinatesReceiver({
                        filter: "mean",
                        filter_size: 5,
                        onGazeCoordinates: function (x, y) {
                            const timeStamp = new Date().getTime();
                            const dateTimeStamp = new Date().toISOString();
                            const data = { x_axis: x, y_axis: y, timestamp: timeStamp, datetimestamp: dateTimeStamp };

                            // Send gaze data to the server
                            if (socket && socket.readyState === WebSocket.OPEN) {
                                socket.send(JSON.stringify(data));
                            }
                        }
                    })
                }
            });
        } else {
            console.log('No active WebSocket connection.');
        }

        // Enhanced color interpolation function for smooth gradient transitions
        function interpolateColor(percentage) {
            if (percentage <= 50) {
                // Red to Orange (0-50%)
                var red = 255;
                var green = Math.min(255, 255 * (percentage / 50));
                return `rgb(${red}, ${green}, 0)`;
            } else {
                // Orange to Green (50-100%)
                var red = Math.max(0, 255 * (2 - percentage / 50));
                var green = 255;
                return `rgb(${red}, ${green}, 0)`;
            }
        }

        function updateCountdown() {
            countdownElement.textContent = timeLeft + " seconds remaining";
            
            // Calculate charging progress (0 to 1)
            var chargingProgress = (totalTime - timeLeft) / totalTime;
            
            // Calculate current charge level: start from currentCharge and increase to finalCharge
            var currentChargeLevel = currentCharge + (chargingProgress * chargeAmount);
            currentChargeLevel = Math.min(currentChargeLevel, finalCharge); // Don't exceed final charge
            
            chargeLevel.style.width = currentChargeLevel + "%";
            batteryPercentage.textContent = Math.round(currentChargeLevel) + "%";

            // Update background position for gradient effect
            var backgroundPos = 100 - currentChargeLevel;
            chargeLevel.style.backgroundPosition = backgroundPos + "% 0";

            if (timeLeft > 0) {
                timeLeft--;
                setTimeout(updateCountdown, 1000);
            } else {
                // Ensure final charge level is set
                chargeLevel.style.width = finalCharge + "%";
                batteryPercentage.textContent = finalCharge + "%";
                
                // Redirect to the next page after charging completes
                window.location.href = "/disabled_charging";
            }
        }

        // Start the countdown and charging animation
        updateCountdown();

        // Add subtle interaction effects for eye tracking studies
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('mousemove', function(e) {
                const container = document.querySelector('.container');
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                
                const rotateX = (y / rect.height) * 1.5;
                const rotateY = (x / rect.width) * -1.5;
                
                container.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
            
            document.addEventListener('mouseleave', function() {
                const container = document.querySelector('.container');
                container.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
            });
        });
    </script>
</body>
</html>